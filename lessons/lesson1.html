<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lesson 1 - Learning Numbers</title>
  <link rel="stylesheet" href="../styles/style.css">
</head>
<body data-required-role="student">
  <div class="app-layout">
    <aside class="app-nav">
      <div class="nav-brand"><span>🌟</span> My Learning Hub</div>
      <section class="nav-section">
        <h2>Grades</h2>
        <nav aria-label="Grade navigation">
          <ul class="nav-links nav-links-compact">
            <li><a href="../grades/grade-k.html">Kindergarten</a></li>
            <li><a href="../grades/grade-1.html">Grade 1</a></li>
            <li><a href="../grades/grade-2.html">Grade 2</a></li>
            <li><a href="../grades/grade-3.html">Grade 3</a></li>
            <li><a href="../grades/grade-4.html">Grade 4</a></li>
            <li><a href="../grades/grade-5.html">Grade 5</a></li>
            <li><a href="../grades/grade-6.html">Grade 6</a></li>
            <li><a href="../grades/grade-7.html">Grade 7</a></li>
            <li><a href="../grades/grade-8.html">Grade 8</a></li>
            <li><a href="../grades/grade-9.html">Grade 9</a></li>
            <li><a href="../grades/grade-10.html">Grade 10</a></li>
            <li><a href="../grades/grade-11.html">Grade 11</a></li>
            <li><a href="../grades/grade-12.html">Grade 12</a></li>
          </ul>
        </nav>
      </section>
      <section class="nav-section">
        <h2>Quick Links</h2>
        <nav aria-label="Utility navigation">
          <ul class="nav-links">
            <li><a href="../frontend/student/dashboard.html">Student Home</a></li>
            <li><a href="../frontend/student/dashboard.html#progress-tracker">Progress Tracker</a></li>
            <li><button type="button" class="link-button" data-sign-out>Sign Out</button></li>
          </ul>
        </nav>
      </section>
      <section class="nav-progress" aria-label="Overall progress">
        Keep it up! <strong data-overall-progress>0%</strong> Course Complete
      </section>
    </aside>

    <main class="app-content">
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <a href="../frontend/student/dashboard.html">Home</a>
        <span aria-hidden="true">›</span>
        <a href="../grades/grade-1.html">Grade 1</a>
        <span aria-hidden="true">›</span>
        <a href="../grades/grade-1.html#math">Math Adventures</a>
        <span aria-hidden="true">›</span>
        <span>Lesson 1</span>
      </nav>

      <header class="lesson-header">
        <div>
          <h1>Lesson 1: Learning Numbers</h1>
          <div class="lesson-meta">
            <p>Explore counting from one to five with colorful visuals and quick questions.</p>
            <p><strong>Objective:</strong> Identify quantities and match them to numerals.</p>
            <ul class="lesson-objectives">
              <li>Count objects up to five.</li>
              <li>Recognize the numeral that matches a set of objects.</li>
              <li>Celebrate success with cheerful sound cues.</li>
            </ul>
          </div>
        </div>
        <aside class="lesson-progress" aria-label="Quiz progress overview">
          <span>Step</span>
          <strong><span id="step-count">1</span>/3</strong>
          <p>Answer each question to finish the activity.</p>
        </aside>
      </header>

      <section class="lesson-content">
        <div class="progress-track" role="progressbar" aria-label="Quiz completion" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div id="quiz-progress" class="progress-bar" style="width: 0%"></div>
        </div>

        <article>
          <figure>
            <img id="question-img" src="../assets/hand.png" alt="Hand showing five fingers">
            <figcaption id="question-text">How many fingers do you have on one hand?</figcaption>
          </figure>
          <div id="quiz-options" class="quiz-choices"></div>
        </article>

        <p id="score" class="feedback" aria-live="polite"></p>

        <div class="lesson-actions">
          <button id="next-btn" class="button" type="button">Next Question</button>
          <a class="button secondary" href="../frontend/student/dashboard.html">Back to Dashboard</a>
        </div>
      </section>
    </main>
  </div>

  <script type="module" src="../scripts/session.js"></script>
  <script src="../scripts/progress.js"></script>
  <script>
    const quizData = [
      {
        question: "How many fingers do you have on one hand?",
        img: "../assets/hand.png",
        alt: "Hand showing five fingers",
        options: ["3", "4", "5", "6"],
        correct: 2
      },
      {
        question: "What number comes after 4?",
        img: "../assets/numbers.png",
        alt: "Number line highlighting the number five",
        options: ["3", "5", "6", "7"],
        correct: 1
      },
      {
        question: "If you have 2 apples and add 2 more, how many do you have?",
        img: "../assets/apples.png",
        alt: "A basket filled with apples",
        options: ["2", "3", "4", "5"],
        correct: 2
      }
    ];

    const lessonId = "math1";
    const quizProgress = document.getElementById("quiz-progress");
    const questionText = document.getElementById("question-text");
    const questionImg = document.getElementById("question-img");
    const quizOptions = document.getElementById("quiz-options");
    const scoreEl = document.getElementById("score");
    const nextBtn = document.getElementById("next-btn");
    const stepCount = document.getElementById("step-count");
    const progressTrack = document.querySelector(".progress-track[role='progressbar']");

    let audioCtx;
    let currentQuestion = 0;
    let score = 0;
    let hasAnswered = false;
    const startTime = performance.now();

    const startTone = (frequency, duration, type = "sine") => {
      if (typeof window.AudioContext !== "function" && typeof window.webkitAudioContext !== "function") {
        return;
      }
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === "suspended") {
        audioCtx.resume();
      }
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.type = type;
      oscillator.frequency.value = frequency;
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      gainNode.gain.setValueAtTime(0.0001, now);
      gainNode.gain.exponentialRampToValueAtTime(0.08, now + 0.02);
      gainNode.gain.exponentialRampToValueAtTime(0.0001, now + duration);
      oscillator.start(now);
      oscillator.stop(now + duration + 0.02);
    };

    const playSuccess = () => startTone(880, 0.4, "triangle");
    const playError = () => startTone(220, 0.5, "sawtooth");

    function updateProgress() {
      const completion = Math.round((currentQuestion / quizData.length) * 100);
      quizProgress.style.width = `${completion}%`;
      progressTrack.setAttribute("aria-valuenow", completion);
      stepCount.textContent = Math.min(currentQuestion + 1, quizData.length);
    }

    function renderQuestion() {
      const q = quizData[currentQuestion];
      hasAnswered = false;
      questionText.textContent = q.question;
      questionImg.src = q.img;
      questionImg.alt = q.alt;
      quizOptions.innerHTML = "";
      scoreEl.textContent = "";
      nextBtn.disabled = true;
      nextBtn.textContent = currentQuestion === quizData.length - 1 ? "Finish Lesson" : "Next Question";

      q.options.forEach((opt, index) => {
        const button = document.createElement("button");
        button.type = "button";
        button.textContent = opt;
        button.addEventListener("click", () => checkAnswer(index));
        quizOptions.append(button);
      });

      updateProgress();
    }

    function checkAnswer(selectedIndex) {
      if (hasAnswered) {
        return;
      }
      hasAnswered = true;
      const q = quizData[currentQuestion];
      const buttons = quizOptions.querySelectorAll("button");

      buttons.forEach((btn, index) => {
        btn.disabled = true;
        if (index === q.correct) {
          btn.classList.add("correct");
        }
        if (index === selectedIndex && index !== q.correct) {
          btn.classList.add("incorrect");
        }
      });

      if (selectedIndex === q.correct) {
        score++;
        scoreEl.textContent = "✅ Great job!";
        playSuccess();
      } else {
        scoreEl.textContent = "❌ Try again next time!";
        playError();
      }

      nextBtn.disabled = false;
      nextBtn.focus();
    }

    nextBtn.addEventListener("click", () => {
      if (!hasAnswered) {
        return;
      }
      currentQuestion++;
      if (currentQuestion < quizData.length) {
        renderQuestion();
      } else {
        quizOptions.innerHTML = "";
        questionImg.src = "../assets/apples.png";
        questionImg.alt = "Celebratory apples forming a heart";
        questionText.textContent = "Amazing work! You finished the quiz.";
        const percentScore = Math.round((score / quizData.length) * 100);
        scoreEl.textContent = `Your score: ${score} / ${quizData.length}`;
        quizProgress.style.width = "100%";
        progressTrack.setAttribute("aria-valuenow", "100");
        stepCount.textContent = quizData.length;
        const durationMs = performance.now() - startTime;
        window.LMSProgress?.markLessonComplete(lessonId, {
          score: percentScore,
          durationMs
        });
        nextBtn.disabled = true;
        nextBtn.textContent = "All done";
      }
    });

    renderQuestion();
  </script>
</body>
</html>
