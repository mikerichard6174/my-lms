<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lesson 2 - Counting Objects</title>
  <link rel="stylesheet" href="../styles/style.css">
</head>
<body data-required-role="student">
  <div class="app-layout">
    <aside class="app-nav">
      <div class="nav-brand"><span>ğŸŒŸ</span> My Learning Hub</div>
      <section class="nav-section">
        <h2>Grades</h2>
        <nav aria-label="Grade navigation">
          <ul class="nav-links nav-links-compact">
            <li><a href="../grades/grade-k.html">Kindergarten</a></li>
            <li><a href="../grades/grade-1.html">Grade 1</a></li>
            <li><a href="../grades/grade-2.html">Grade 2</a></li>
            <li><a href="../grades/grade-3.html">Grade 3</a></li>
            <li><a href="../grades/grade-4.html">Grade 4</a></li>
            <li><a href="../grades/grade-5.html">Grade 5</a></li>
            <li><a href="../grades/grade-6.html">Grade 6</a></li>
            <li><a href="../grades/grade-7.html">Grade 7</a></li>
            <li><a href="../grades/grade-8.html">Grade 8</a></li>
            <li><a href="../grades/grade-9.html">Grade 9</a></li>
            <li><a href="../grades/grade-10.html">Grade 10</a></li>
            <li><a href="../grades/grade-11.html">Grade 11</a></li>
            <li><a href="../grades/grade-12.html">Grade 12</a></li>
          </ul>
        </nav>
      </section>
      <section class="nav-section">
        <h2>Quick Links</h2>
        <nav aria-label="Utility navigation">
          <ul class="nav-links">
            <li><a href="../frontend/student/dashboard.html">Student Home</a></li>
            <li><a href="../frontend/student/dashboard.html#progress-tracker">Progress Tracker</a></li>
            <li><button type="button" class="link-button" data-sign-out>Sign Out</button></li>
          </ul>
        </nav>
      </section>
      <section class="nav-progress" aria-label="Overall progress">
        Keep it up! <strong data-overall-progress>0%</strong> Course Complete
      </section>
    </aside>

    <main class="app-content">
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <a href="../frontend/student/dashboard.html">Home</a>
        <span aria-hidden="true">â€º</span>
        <a href="../grades/grade-1.html">Grade 1</a>
        <span aria-hidden="true">â€º</span>
        <a href="../grades/grade-1.html#math">Math Adventures</a>
        <span aria-hidden="true">â€º</span>
        <span>Lesson 2</span>
      </nav>

      <header class="lesson-header">
        <div>
          <h1>Lesson 2: Counting Objects</h1>
          <div class="lesson-meta">
            <p>Drag the apples into the basket to match the target number.</p>
            <p><strong>Objective:</strong> Practice one-to-one correspondence by placing the right number of objects.</p>
            <ul class="lesson-objectives">
              <li>Drag apples to the basket using a mouse or touch.</li>
              <li>Count each apple as you move it to the basket.</li>
              <li>Check your answer and try again if needed.</li>
            </ul>
          </div>
        </div>
        <aside class="lesson-progress" aria-label="Activity progress overview">
          <span>Target</span>
          <strong><span id="target-count">3</span></strong>
          <p>Place this many apples in the basket.</p>
        </aside>
      </header>

      <section class="lesson-content">
        <h2>Build Your Basket</h2>
        <p>Drag apples from the orchard into the basket. When you think you have the right number, choose <em>Check Answer</em>.</p>

        <div class="drop-zone" id="basket" aria-label="Apple basket" aria-describedby="basket-count" tabindex="0">
          <p id="basket-count">Basket has <span id="apples-in-basket">0</span> apples.</p>
        </div>

        <div class="drag-bank" id="orchard" aria-label="Apple orchard">
          <span class="drag-token" role="img" aria-label="apple" draggable="true" data-token-id="apple-1">ğŸ</span>
          <span class="drag-token" role="img" aria-label="apple" draggable="true" data-token-id="apple-2">ğŸ</span>
          <span class="drag-token" role="img" aria-label="apple" draggable="true" data-token-id="apple-3">ğŸ</span>
          <span class="drag-token" role="img" aria-label="apple" draggable="true" data-token-id="apple-4">ğŸ</span>
          <span class="drag-token" role="img" aria-label="apple" draggable="true" data-token-id="apple-5">ğŸ</span>
        </div>

        <p id="feedback" class="feedback" aria-live="polite"></p>

        <div class="lesson-actions">
          <button class="button" type="button" id="check-answer">Check Answer</button>
          <button class="button secondary" type="button" id="reset">Reset Activity</button>
          <a class="button secondary" href="../frontend/student/dashboard.html">Back to Dashboard</a>
        </div>
      </section>
    </main>
  </div>

  <script type="module" src="../scripts/session.js"></script>
  <script src="../scripts/progress.js"></script>
  <script>
    const lessonId = "math2";
    const basket = document.getElementById("basket");
    const orchard = document.getElementById("orchard");
    const tokens = document.querySelectorAll(".drag-token");
    const feedback = document.getElementById("feedback");
    const applesInBasket = document.getElementById("apples-in-basket");
    const checkButton = document.getElementById("check-answer");
    const resetButton = document.getElementById("reset");
    const targetCount = 3;

    let draggedId = null;
    let activityStart = performance.now();

    function updateCount() {
      const count = basket.querySelectorAll(".drag-token").length;
      applesInBasket.textContent = count;
      return count;
    }

    function handleDragStart(event) {
      draggedId = event.target.dataset.tokenId;
      event.dataTransfer.effectAllowed = "move";
      basket.classList.remove("correct", "incorrect");
      feedback.textContent = "";
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = "move";
      event.currentTarget.classList.add("is-active");
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove("is-active");
    }

    function handleDrop(event) {
      event.preventDefault();
      const dropTarget = event.currentTarget;
      const token = document.querySelector(`[data-token-id="${draggedId}"]`);
      if (!token) {
        return;
      }
      dropTarget.classList.remove("is-active");
      if (!dropTarget.contains(token)) {
        dropTarget.appendChild(token);
      }
      updateCount();
      draggedId = null;
    }

    tokens.forEach(token => {
      token.addEventListener("dragstart", handleDragStart);
      token.addEventListener("dragend", () => {
        draggedId = null;
        basket.classList.remove("is-active");
        orchard.classList.remove("is-active");
      });
    });

    [basket, orchard].forEach(zone => {
      zone.addEventListener("dragover", handleDragOver);
      zone.addEventListener("dragleave", handleDragLeave);
      zone.addEventListener("drop", handleDrop);
    });

    checkButton.addEventListener("click", () => {
      const count = updateCount();
      basket.classList.remove("correct", "incorrect");
      const elapsed = performance.now() - activityStart;
      const ratio = Math.max(0, Math.min(count / targetCount, 1));
      const percent = Math.round(ratio * 100);
      if (count === targetCount) {
        basket.classList.add("correct");
        feedback.textContent = "ğŸ Correct! You counted perfectly.";
        window.LMSProgress?.markLessonComplete(lessonId, {
          score: 100,
          durationMs: elapsed
        });
      } else {
        basket.classList.add("incorrect");
        feedback.textContent = `Try again. You need ${targetCount} apples.`;
        window.LMSProgress?.recordLessonAttempt?.(lessonId, {
          score: percent,
          durationMs: elapsed,
          completed: false
        });
      }
    });

    resetButton.addEventListener("click", () => {
      tokens.forEach(token => orchard.appendChild(token));
      basket.classList.remove("correct", "incorrect", "is-active");
      feedback.textContent = "";
      updateCount();
      activityStart = performance.now();
    });

    updateCount();
  </script>
</body>
</html>
